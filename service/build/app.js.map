{"version":3,"file":"app.js","names":["express","require","app","cors","quertstring","expressjwt","jwt","auth","Auth","jwks","jwtCheck","secret","expressJwtSecret","cache","rateLimit","jwksRequestsPerMinute","jwksUri","config","audience","issuer","algorithms","unless","path","use","get","req","res","result","authAccount","headers","authorization","active","status","send","scope","console","log","split","includes","listen"],"sources":["../src/app.js"],"sourcesContent":["import { Auth } from \"./auth.js\";\r\nimport {config} from './dev.js';\r\n\r\nconst express = require(\"express\");\r\nconst app = express();\r\n\r\nconst cors=require(\"cors\");\r\n\r\nvar quertstring = require(\"querystring\");\r\n\r\nvar { expressjwt: jwt } = require(\"express-jwt\");\r\n\r\nconst auth = new Auth();\r\n\r\nvar jwks = require(\"jwks-rsa\");\r\n\r\nvar jwtCheck = jwt({\r\n  secret: jwks.expressJwtSecret({\r\n    cache: true,\r\n    rateLimit: true,\r\n    jwksRequestsPerMinute: 5,\r\n    jwksUri:\r\n      config.jwks,\r\n  }),\r\n  audience: config.audience,\r\n  issuer: config.issuer,\r\n  algorithms: [\"RS256\"],\r\n}).unless({ path: [/^\\/api\\//] });\r\n\r\n//app.use(jwtCheck);\r\napp.use(cors());\r\n\r\napp.get(\"/api/face\", async (req, res) => {\r\n  var result = await auth.authAccount(req.headers.authorization);\r\n\r\n  if (!result.active) {\r\n    //accesstoken 已经过期\r\n    res.status(200).send(\"accesstoken expired\");\r\n\r\n    return;\r\n  }\r\n\r\n  if (result.scope == \"\") {\r\n    res.status(200).send(\"not authorize\");\r\n    return;\r\n  }\r\n  console.log(result.scope.split(' ').includes('face:call'));\r\n  if (result.scope.split(\" \").includes(\"face:call\")) {\r\n    res.status(200).send(\"face\");\r\n  } else {\r\n    res.status(200).send(\"not authorize\");\r\n  }\r\n});\r\n\r\napp.get(\"/api/gender\", async (req, res) => {\r\n  var result = await auth.authAccount(req.headers.authorization);\r\n\r\n  if (!result.active) {\r\n    //accesstoken 已经过期\r\n    res.status(200).send(\"accesstoken expired\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope == \"\") {\r\n    res.status(200).send(\"not authorize\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope.split(\" \").includes(\"gender:call\")) {\r\n    res.status(200).send(\"gender\");\r\n  } else {\r\n    res.status(200).send(\"not authorize\");\r\n  }\r\n});\r\n\r\napp.get(\"/api/object\", async (req, res) => {\r\n  var result = await auth.authAccount(req.headers.authorization);\r\n\r\n  if (!result.active) {\r\n    //accesstoken 已经过期\r\n    res.status(200).send(\"accesstoken expired\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope == \"\") {\r\n    res.status(200).send(\"not authorize\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope.split(\" \").includes(\"object:call\")) {\r\n    res.status(200).send(\"object\");\r\n  } else {\r\n    res.status(200).send(\"not authorize\");\r\n  }\r\n});\r\n\r\napp.get(\"/api/action\", async (req, res) => {\r\n  var result = await auth.authAccount(req.headers.authorization);\r\n\r\n  if (!result.active) {\r\n    //accesstoken 已经过期\r\n    res.status(200).send(\"accesstoken expired\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope == \"\") {\r\n    res.status(200).send(\"not authorize\");\r\n    return;\r\n  }\r\n\r\n  if (result.scope.split(\" \").includes(\"action:call\")) {\r\n    res.status(200).send(\"action\");\r\n  } else {\r\n    res.status(200).send(\"not authorize\");\r\n  }\r\n});\r\n\r\napp.listen(3000, () => {\r\n  console.log(\"app listening on port 3000\");\r\n});\r\n"],"mappings":"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"}